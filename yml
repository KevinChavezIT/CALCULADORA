---
- name: Test de conexión a servidores AIX VIOs - Corregido
  hosts: vios
  gather_facts: no
  
  # Configuración específica para AIX
  vars:
    ansible_shell_type: sh  # Usar sh en lugar de ksh
    ansible_executable: /usr/bin/ksh  # Especificar ejecutable de shell
  
  tasks:
    - name: Verificar si existe /usr/bin/ksh
      ansible.builtin.command:
        cmd: "ls -la /usr/bin/ksh"
      register: ksh_check
      ignore_errors: yes
      delegate_to: localhost  # Ejecutar localmente para debug
    
    - name: Debug - Mostrar resultado de verificación ksh
      ansible.builtin.debug:
        var: ksh_check
      delegate_to: localhost
    
    - name: Probar conexión con shell por defecto del sistema
      ansible.builtin.raw: |
        echo "Conectado exitosamente a $(hostname)"
        echo "Shell actual: $SHELL"
        echo "Usuario: $(whoami)"
      register: raw_test
      
    - name: Mostrar resultado conexión raw
      ansible.builtin.debug:
        msg: "{{ raw_test.stdout_lines }}"
        
    - name: Verificar versión del sistema (método robusto)
      ansible.builtin.raw: "oslevel -s"
      register: os_version
      
    - name: Mostrar versión AIX
      ansible.builtin.debug:
        msg: "{{ inventory_hostname }} - Versión AIX: {{ os_version.stdout }}"
        
    - name: Verificar si es VIO Server
      ansible.builtin.raw: |
        if [ -x /usr/ios/cli/ioscli ]; then
          echo "Es un VIO Server"
          /usr/ios/cli/ioscli ioslevel 2>/dev/null || echo "No se pudo obtener ioslevel"
        else
          echo "No es un VIO Server (es AIX estándar)"
        fi
      register: vio_check
      
    - name: Mostrar resultado verificación VIO
      ansible.builtin.debug:
        msg: "{{ vio_check.stdout_lines }}"